name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: oven-sh/setup-bun@v2

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('webapp/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0
          args: ./server/...
          only-new-issues: true

      - name: Install webapp dependencies
        run: cd webapp && bun install --frozen-lockfile

      - name: Lint JavaScript
        run: cd webapp && bun run lintjs

      - name: Lint CSS
        run: cd webapp && bun run lintstyle

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run server tests
        run: go test -gcflags='all=-l' -v -coverprofile=coverage.txt ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.txt
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-webapp:
    name: Build Webapp
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('webapp/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install dependencies
        run: cd webapp && bun install --frozen-lockfile

      - name: Build webapp
        run: cd webapp && bun run build

      - name: Upload webapp artifact
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: webapp/dist/
          retention-days: 7

  build-plugin:
    name: Build Plugin (${{ matrix.goos }}-${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [lint, test, build-webapp]
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            platform: linux-amd64
          - goos: linux
            goarch: arm64
            platform: linux-arm64
          - goos: darwin
            goarch: amd64
            platform: darwin-amd64
          - goos: darwin
            goarch: arm64
            platform: darwin-arm64
          - goos: windows
            goarch: amd64
            platform: windows-amd64
            ext: .exe
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Download webapp artifact
        uses: actions/download-artifact@v4
        with:
          name: webapp
          path: webapp-dist

      - name: Get plugin info
        id: plugin
        run: |
          echo "id=$(node -p "require('./plugin.json').id")" >> $GITHUB_OUTPUT
          echo "version=v$(node -p "require('./plugin.json').version")" >> $GITHUB_OUTPUT

      - name: Build server binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          PLUGIN_VERSION="${{ steps.plugin.outputs.version }}"
          ICON_BASE64=$(base64 < webapp/src/assets/images/logo.svg | tr -d '\n')
          LDFLAGS="-s -w -X 'main.PluginVersion=${PLUGIN_VERSION}' -X 'main.EncodedPluginIcon=data:image/svg+xml;base64,${ICON_BASE64}'"

          mkdir -p dist
          go build -ldflags "${LDFLAGS}" -o dist/plugin${{ matrix.ext }} ./server

      - name: Package plugin
        run: |
          PLUGIN_ID="${{ steps.plugin.outputs.id }}"
          PLUGIN_VERSION="${{ steps.plugin.outputs.version }}"
          PACKAGE_NAME="mattermost-plugin-${PLUGIN_ID}-${PLUGIN_VERSION}-${{ matrix.platform }}"

          mkdir -p package/${PLUGIN_ID}/server
          mkdir -p package/${PLUGIN_ID}/webapp

          # Copy server binary
          cp dist/plugin${{ matrix.ext }} package/${PLUGIN_ID}/server/plugin${{ matrix.ext }}

          # Copy webapp
          cp -r webapp-dist/* package/${PLUGIN_ID}/webapp/

          # Add timezone options to plugin.json and copy
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('plugin.json', 'utf8'));
            const timezones = JSON.parse(fs.readFileSync('timezones.json', 'utf8'));
            manifest.settings_schema.settings[0].options = timezones;
            fs.writeFileSync('package/${PLUGIN_ID}/plugin.json', JSON.stringify(manifest, null, 2));
          "

          # Create tarball
          cd package
          tar -czf ../${PACKAGE_NAME}.tar.gz ${PLUGIN_ID}/

          # Generate checksum
          cd ..
          sha256sum ${PACKAGE_NAME}.tar.gz > ${PACKAGE_NAME}.sha256
          cat ${PACKAGE_NAME}.sha256

      - name: Upload plugin package
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.platform }}
          path: |
            *.tar.gz
            *.sha256
          retention-days: 30
          compression-level: 0
